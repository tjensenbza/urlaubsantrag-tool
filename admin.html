<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <title>Adminbereich – Urlaubsanträge</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <style>
    :root { --card-border:#ddd; --muted:#666; --blue:#004b9b; }
    body { font-family: system-ui, sans-serif; padding: 2em; max-width: 1100px; margin:auto; }
    h1 { margin-top:0 }
    table { width: 100%; border-collapse: collapse; margin-top: 1em; }
    th, td { border: 1px solid #ccc; padding: 0.5em; text-align: left; vertical-align: top; }
    th:first-child, td:first-child { width: 40px; text-align:center; }
    .toolbar { display:flex; flex-wrap:wrap; gap: .5rem; align-items:center; margin-bottom:.5rem; }
    .toolbar button, .toolbar a { padding:.5rem .75rem; border:1px solid #ccc; background:#fff; cursor:pointer; border-radius:.4rem; text-decoration:none; color:#111; }
    .toolbar button:hover, .toolbar a:hover { background:#f7f7f7; }
    .status { margin: .75rem 0 0; padding: .75rem; background:#f6f6f6; border-radius: .5rem; }
    .error { color:#b00020; font-weight:600; }

    /* Druck */
    @media print {
      h1, .toolbar, #antraegeTable, .status { display: none !important; }
      #printArea { display: block !important; position: static !important; width: 100%; margin: 0; padding: 0; }
      .print-card { page-break-after: always; break-after: page; }
    }

    #printArea { padding: 20px; }
    .print-header { text-align:center; margin-bottom: 16px; }
    .print-header .firm-name { font-size: 18px; font-weight: bold; color: var(--blue); margin-bottom: 8px; }
    .print-header .title { font-size: 20px; font-weight: 700; }
    .print-header .sub { color: var(--muted); font-size: 12px; margin-top: 4px; }
    .print-card { border:1px solid var(--card-border); border-radius: 8px; padding: 12px 14px; margin: 12px 0; }
    .print-row { display:flex; gap:12px; flex-wrap:wrap; }
    .print-row div { min-width: 220px; }
    .print-label { font-size: 12px; color: var(--muted); }
    .print-value { font-size: 14px; font-weight: 600; }
    .print-zeitraeume { margin-top: 8px; }
    .print-zeitraeume ul { margin: 6px 0 0 18px; }
  </style>
</head>
<body>
  <h1>Urlaubsanträge – Admin</h1>

  <div class="toolbar">
    <button onclick="reload()">Neu laden</button>
    <button onclick="toggleAll(true)">Alle auswählen</button>
    <button onclick="toggleAll(false)">Auswahl aufheben</button>
    <button onclick="printSelected()">Auswahl drucken (PDF)</button>
    <button onclick="logout()">Logout</button>
    <a href="index.html">Zur Antrag-Seite</a>
  </div>

  <div id="status" class="status">Lade Daten…</div>

  <table id="antraegeTable">
    <thead>
      <tr>
        <th><input type="checkbox" id="checkAll" /></th>
        <th>Vorname</th>
        <th>Nachname</th>
        <th>Antragsdatum</th>
        <th>Zeiträume (mit Arbeitstagen)</th>
        <th>Erstellt am</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="printArea"></div>

  <script>
    if (localStorage.getItem("admin_logged_in") !== "true") {
      alert("Zugriff verweigert. Bitte zuerst einloggen.");
      window.location.href = "login.html";
    }

    const SUPABASE_URL = 'https://fdsedmqvonfsegyfvqwq.supabase.co';
    const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImZkc2VkbXF2b25mc2VneWZ2cXdxIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NDA3MTUsImV4cCI6MjA2NzAxNjcxNX0.85AKLlUGAtOsLm8Om6rx19ZpPBYF8kf3xrL6NiTPCME';
    const sb = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    let cache = [];

    /* ---------- Arbeits­tage (Mo–Fr) in NI mit Feiertagen ---------- */
    function dateFromISO(iso) {
      const [y,m,d] = iso.split('-').map(Number);
      return new Date(Date.UTC(y, m-1, d));
    }
    function isoFromDateUTC(dt){
      const y = dt.getUTCFullYear();
      const m = String(dt.getUTCMonth()+1).padStart(2,'0');
      const d = String(dt.getUTCDate()).padStart(2,'0');
      return `${y}-${m}-${d}`;
    }
    function addDaysUTC(dt, days){
      const nd = new Date(dt.getTime());
      nd.setUTCDate(nd.getUTCDate() + days);
      return nd;
    }
    // Gauß/Oudin-Algorithmus: Ostersonntag
    function easterSunday(year){
      const a = year % 19;
      const b = Math.floor(year/100);
      const c = year % 100;
      const d = Math.floor(b/4);
      const e = b % 4;
      const f = Math.floor((b + 8) / 25);
      const g = Math.floor((b - f + 1) / 3);
      const h = (19*a + b - d - g + 15) % 30;
      const i = Math.floor(c/4);
      const k = c % 4;
      const l = (32 + 2*e + 2*i - h - k) % 7;
      const m = Math.floor((a + 11*h + 22*l) / 451);
      const month = Math.floor((h + l - 7*m + 114) / 31); // 3=March, 4=April
      const day = ((h + l - 7*m + 114) % 31) + 1;
      return new Date(Date.UTC(year, month-1, day));
    }
    // Feiertage Niedersachsen für ein Jahr als Set von ISO-Strings (nur wenn Mo–Fr relevant)
    function holidaysNI(year){
      const set = new Set();
      const push = (dt) => {
        const wd = dt.getUTCDay(); // 0 So, 6 Sa
        if (wd>=1 && wd<=5) set.add(isoFromDateUTC(dt));
      };
      const easter = easterSunday(year);
      const goodFriday   = addDaysUTC(easter, -2);
      const easterMonday = addDaysUTC(easter,  1);
      const ascension    = addDaysUTC(easter, 39);
      const whitMonday   = addDaysUTC(easter, 50);

      // Fixe Feiertage
      push(new Date(Date.UTC(year,0,1)));   // Neujahr
      push(goodFriday);
      push(easterMonday);
      push(new Date(Date.UTC(year,4,1)));   // 1. Mai
      push(ascension);                      // Christi Himmelfahrt
      push(whitMonday);                     // Pfingstmontag
      push(new Date(Date.UTC(year,9,3)));   // Tag d. Dt. Einheit
      push(new Date(Date.UTC(year,11,25))); // 1. Weihnachtstag
      push(new Date(Date.UTC(year,11,26))); // 2. Weihnachtstag
      push(new Date(Date.UTC(year,9,31)));  // Reformationstag (NI)
      // Heiligabend/Silvester sind KEINE vollen Feiertage – werden separat als 0,5 behandelt
      return set;
    }
    function workdaysNI(fromIso, toIso){
      if (!fromIso || !toIso) return 0;
      let start = dateFromISO(fromIso);
      let end   = dateFromISO(toIso);
      if (end < start) [start, end] = [end, start];

      // Feiertage für alle betroffenen Jahre vorbereiten
      const years = [];
      for (let y = start.getUTCFullYear(); y <= end.getUTCFullYear(); y++) years.push(y);
      const holidaySets = Object.fromEntries(years.map(y => [y, holidaysNI(y)]));

      let total = 0;
      let cur = start;
      while (cur <= end) {
        const dow = cur.getUTCDay();
        const isWeekday = (dow >= 1 && dow <= 5);
        if (isWeekday) {
          const iso = isoFromDateUTC(cur);
          const y = cur.getUTCFullYear();
          if (holidaySets[y].has(iso)) {
            // voller Feiertag (−1), aber nur wenn Wochentag (ist er)
            // → nichts adden (überspringen)
          } else {
            // regulärer Arbeitstag
            total += 1;
            // 0,5 Abzug an Heiligabend/Silvester, falls Wochentag
            const m = cur.getUTCMonth()+1, d = cur.getUTCDate();
            if ((m === 12 && d === 24) || (m === 12 && d === 31)) {
              total -= 0.5;
            }
          }
        }
        cur = addDaysUTC(cur, 1);
      }
      // Runde auf .0 oder .5
      return Math.round(total * 2) / 2;
    }
    function formatDays(n){
      const s = (Number.isInteger(n) ? n.toString() : n.toFixed(1)).replace('.', ',');
      return `${s} Arbeitstage`;
    }

    /* ---------- Daten laden & rendern ---------- */
    async function ladeAntraege() {
      setStatus('Lade Daten…');
      const { data, error } = await sb
        .from('urlaubsantraege')
        .select('*')
        .order('erstellt_am', { ascending: false });

      const tbody = document.querySelector("#antraegeTable tbody");
      tbody.innerHTML = "";

      if (error) {
        console.error(error);
        setStatus('❌ <span class="error">Fehler beim Laden: ' + (error.message || 'unbekannt') + '</span>');
        return;
      }

      cache = data || [];
      if (!cache.length) { setStatus('ℹ️ Keine Einträge vorhanden.'); return; }

      cache.forEach((eintrag, idx) => {
        const zeitraeumeHtml = (eintrag.zeitraeume || []).map(z => {
          const days = workdaysNI(z.von, z.bis);
          return `${z.von} bis ${z.bis} – ${formatDays(days)}`;
        }).join('<br>');

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td><input type="checkbox" class="row-check" data-index="${idx}"></td>
          <td>${eintrag.vorname || ''}</td>
          <td>${eintrag.nachname || ''}</td>
          <td>${eintrag.antragsdatum || ''}</td>
          <td>${zeitraeumeHtml || '-'}</td>
          <td>${eintrag.erstellt_am ? new Date(eintrag.erstellt_am).toLocaleString('de-DE') : ''}</td>
        `;
        tbody.appendChild(tr);
      });

      const checkAll = document.getElementById('checkAll');
      checkAll.checked = false;
      checkAll.onchange = () => toggleAll(checkAll.checked);

      setStatus('✅ ' + cache.length + ' Eintrag(e) geladen.');
    }

    function toggleAll(state) {
      document.querySelectorAll('.row-check').forEach(cb => cb.checked = state);
      document.getElementById('checkAll').checked = state;
    }
    function getSelected() {
      const selectedIdx = Array.from(document.querySelectorAll('.row-check'))
        .filter(cb => cb.checked)
        .map(cb => Number(cb.dataset.index));
      return selectedIdx.map(i => cache[i]);
    }

    async function printSelected() {
      const sel = getSelected();
      if (!sel.length) { alert('Bitte mindestens einen Antrag auswählen.'); return; }

      const printArea = document.getElementById('printArea');
      const today = new Date().toLocaleDateString('de-DE');
      const body = sel.map(e => {
        const zeitraeume = (e.zeitraeume || []).map(z => {
          const days = workdaysNI(z.von, z.bis);
          return `<li>${z.von} bis ${z.bis} – ${formatDays(days)}</li>`;
        }).join('');

        return `
          <div class="print-card">
            <div class="print-header">
              <div class="firm-name">Semco Glasdesign GmbH Co. KG</div>
              <div class="title">Urlaubsgenehmigung</div>
              <div class="sub">Erstellt am ${today}</div>
            </div>

            <div class="print-row">
              <div>
                <div class="print-label">Vorname</div>
                <div class="print-value">${e.vorname || ''}</div>
              </div>
              <div>
                <div class="print-label">Nachname</div>
                <div class="print-value">${e.nachname || ''}</div>
              </div>
              <div>
                <div class="print-label">Antragsdatum</div>
                <div class="print-value">${e.antragsdatum || ''}</div>
              </div>
              <div>
                <div class="print-label">Erstellt am</div>
                <div class="print-value">${e.erstellt_am ? new Date(e.erstellt_am).toLocaleString('de-DE') : ''}</div>
              </div>
            </div>

            <div class="print-zeitraeume">
              <div class="print-label">Urlaubszeiträume</div>
              ${zeitraeume ? `<ul>${zeitraeume}</ul>` : '<div class="print-value">–</div>'}
            </div>

            <div style="margin-top:24px; display:flex; justify-content:space-between; gap:40px;">
              <div style="flex:1; text-align:center;">
                <div style="border-top:1px solid #000; margin-top:40px; padding-top:4px; font-size:12px;">Unterschrift Antragsteller</div>
              </div>
              <div style="flex:1; text-align:center;">
                <div style="border-top:1px solid #000; margin-top:40px; padding-top:4px; font-size:12px;">Unterschrift Vorgesetzter</div>
              </div>
            </div>
          </div>
        `;
      }).join('');

      printArea.innerHTML = body;
      await new Promise(requestAnimationFrame);
      await new Promise(res => setTimeout(res, 50));
      window.print();
      setTimeout(() => { printArea.innerHTML = ''; }, 300);
    }

    function setStatus(html) { document.getElementById('status').innerHTML = html; }
    function logout() { localStorage.removeItem("admin_logged_in"); window.location.href = "login.html"; }
    function reload() { ladeAntraege(); }

    ladeAntraege();
  </script>
</body>
</html>
